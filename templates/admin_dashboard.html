<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        h2 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: #343a40;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Quiz Master</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" >Welcome, Admin</a></li>
                    <li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Admin Dashboard</h2>
    
        <form action="/search" method="GET" class="mb-4">
            <div class="input-group">
                <input type="text" name="query" class="form-control" placeholder="Search users, subjects, or quizzes..." required>
                <button class="btn btn-primary" type="submit">Search</button>
            </div>
        </form>

        <h3>Users</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>S No.</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ user.full_name }}</td>
                    <td>{{ user.username }}</td>
                    <td>
                        <a href="/view_user/{{ user.id }}" class="btn btn-info btn-sm">View Details</a>
                        <form action="/delete_user/{{ user.id }}" method="POST" style="display:inline;">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3>Subjects</h3>
        <ul class="list-group">
            {% for subject in subjects %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ subject.name }}
                <div>
                    <a href="{{ url_for('chapters', subject_id=subject.id) }}" class="btn btn-info btn-sm">View Chapters</a>
                    <a href="/edit_subject/{{ subject.id }}" class="btn btn-warning btn-sm" >Edit</a>
                    <form action="/delete_subject/{{ subject.id }}" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-danger btn-sm ms-2">Delete</button>
                    </form>
                </div>
            </li>
            {% endfor %}
        </ul>
        <p></p>
        <a href="/add_subject" class="btn btn-primary mb-3">Add Subject</a>
    </div>    

    <div class="container mt-4">
        <h3>Quiz Summary</h3>
        <div class="row">
            <div class="col-md-4">
                <div class="card text-white bg-success mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Users Per Quiz</h5>
                        <ul class="list-group">
                            {% for quiz in quiz_user_attempts %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Quiz {{ quiz.quiz_id }}</strong> - {{ quiz.chapter_name }}
                                </div>
                                <div>
                                    <span class="badge bg-dark rounded-pill">{{ quiz.user_count }}</span>
                                    <a href="{{ url_for('view_quiz_users', quiz_id=quiz.quiz_id) }}" class="btn btn-info btn-sm">View Users</a>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
    
            <div class="col-md-4">
                <div class="card text-white bg-primary mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Total Quizzes Attempted</h5>
                        <p class="card-text fs-3">{{ total_quizzes_attempted }}</p>
                        <a href="{{ url_for('quiz_history') }}" class="btn btn-light">View Quiz History</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    

    <div class="container mt-4">
        <h3>Chapter Quiz Attempts per Day</h3>
        <canvas id="chapterDayChart"></canvas>
    </div>
    
    <script>
        fetch('/quiz_trends')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('chapterDayChart').getContext('2d');
    
                const chapterLabels = data.chapters_day.map(c => c.name);
                const chapterAttempts = data.chapters_day.map(c => c.attempts);
    
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chapterLabels,
                        datasets: [{
                            label: 'Attempts per Chapter (Today)',
                            data: chapterAttempts,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            });
    </script>
    
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
